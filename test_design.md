# 备份助手项目测试设计方案

## 1. 测试策略与框架选择

### 1.1 测试策略
- **分层测试**：单元测试 → 集成测试 → 端到端测试 → 性能测试
- **测试覆盖率目标**：核心功能模块覆盖率 ≥ 80%
- **持续集成**：每次代码提交自动运行测试套件

### 1.2 测试框架
- **单元测试框架**：Google Test (已在项目中使用)
- **测试运行器**：CTest (通过CMake集成)
- **模拟框架**：gmock (用于模拟依赖组件)

## 2. 单元测试设计

### 2.1 核心模块测试

#### 2.1.1 File类测试 (core/models/File.hpp)
- **测试目标**：验证File类的属性获取和元数据处理
- **测试用例**：
  - 构造函数和属性访问器测试
  - 元数据获取测试（大小、修改时间、权限等）
  - 文件类型检测测试（正则文件、目录、符号链接等）
  - 路径处理测试

#### 2.1.2 BackupTask测试 (core/tasks/BackupTask.hpp)
- **测试目标**：验证备份任务的创建、执行和状态管理
- **测试用例**：
  - BackupTask构造和配置测试
  - 备份任务执行流程测试
  - 任务状态转换测试（等待、运行、完成、失败）
  - 异常处理测试

#### 2.1.3 RestoreTask测试 (core/tasks/RestoreTask.hpp)
- **测试目标**：验证还原任务的创建、执行和状态管理
- **测试用例**：
  - RestoreTask构造和配置测试
  - 还原任务执行流程测试
  - 任务状态转换测试
  - 异常处理测试

#### 2.1.4 BackupEngine测试 (core/BackupEngine.hpp)
- **测试目标**：验证备份引擎的核心逻辑
- **测试用例**：
  - 备份引擎初始化测试
  - 备份策略执行测试
  - 任务调度测试
  - 事件处理测试

#### 2.1.5 DataProcessor测试 (core/DataProcessor.hpp)
- **测试目标**：验证数据处理流程
- **测试用例**：
  - 文件扫描和收集测试
  - 数据转换测试
  - 过滤逻辑集成测试

#### 2.1.6 Filter测试 (core/Filter.hpp)
- **测试目标**：验证各种过滤器的功能（已实现）
- **已覆盖**：PathFilter, TypeFilter, SizeFilter, NameFilter, TimeFilter

#### 2.1.7 RealTimeBackupManager测试 (core/RealTimeBackupManager.hpp)
- **测试目标**：验证实时备份管理功能
- **测试用例**：
  - 实时监控启动和停止测试
  - 文件变更检测测试
  - 实时备份触发测试
  - 并发处理测试

#### 2.1.8 TimerBackupManager测试 (core/TimerBackupManager.hpp)
- **测试目标**：验证定时备份管理功能
- **测试用例**：
  - 定时器配置测试
  - 定时备份触发测试
  - 多任务调度测试

### 2.2 工具类测试

#### 2.2.1 Encryption测试 (utils/Encryption.hpp)
- **测试目标**：验证加密解密功能
- **测试用例**：
  - AES加密解密测试
  - DES加密解密测试
  - 不同密钥长度测试
  - 异常处理测试

#### 2.2.2 FilePackager测试 (utils/FilePackager.hpp)
- **测试目标**：验证文件打包解包功能
- **测试用例**：
  - 单文件打包解包测试
  - 多文件打包解包测试
  - 目录结构保留测试
  - 异常处理测试

#### 2.2.3 FileSystem测试 (utils/FileSystem.hpp)
- **测试目标**：验证文件系统操作封装
- **测试用例**：
  - 文件创建、读取、写入测试
  - 目录操作测试
  - 文件元数据操作测试
  - 异常处理测试

#### 2.2.4 HuffmanCompressor测试 (utils/HuffmanCompressor.hpp)
- **测试目标**：验证Huffman压缩算法
- **测试用例**：
  - 文本文件压缩解压测试
  - 二进制文件压缩解压测试
  - 压缩率测试
  - 异常处理测试

#### 2.2.5 ConsoleLogger测试 (utils/ConsoleLogger.hpp)
- **测试目标**：验证日志记录功能
- **测试用例**：
  - 不同日志级别测试
  - 日志格式测试
  - 多线程环境测试

## 3. 集成测试设计

### 3.1 模块间集成测试

#### 3.1.1 BackupEngine与Task集成测试
- **测试目标**：验证BackupEngine能够正确创建、调度和执行备份/还原任务
- **测试场景**：
  - BackupEngine创建并执行BackupTask
  - BackupEngine创建并执行RestoreTask
  - 任务依赖关系测试

#### 3.1.2 DataProcessor与Filter集成测试
- **测试目标**：验证DataProcessor能够正确应用各种过滤器
- **测试场景**：
  - DataProcessor应用PathFilter
  - DataProcessor应用多过滤器组合
  - 过滤结果正确性验证

#### 3.1.3 BackupTask与FilePackager集成测试
- **测试目标**：验证备份任务能够正确使用FilePackager打包文件
- **测试场景**：
  - 备份任务生成打包文件
  - 打包文件内容验证

#### 3.1.4 RestoreTask与FilePackager集成测试
- **测试目标**：验证还原任务能够正确使用FilePackager解包文件
- **测试场景**：
  - 还原任务解包备份文件
  - 还原文件完整性验证

### 3.2 功能集成测试

#### 3.2.1 完整备份流程测试
- **测试目标**：验证从文件扫描到打包的完整备份流程
- **测试场景**：
  - 配置备份任务
  - 执行备份
  - 验证备份文件生成
  - 验证备份日志

#### 3.2.2 完整还原流程测试
- **测试目标**：验证从备份文件到还原完成的完整流程
- **测试场景**：
  - 配置还原任务
  - 执行还原
  - 验证还原文件完整性
  - 验证还原日志

## 4. 端到端测试设计

### 4.1 核心功能端到端测试

#### 4.1.1 基础备份还原测试
- **测试目标**：验证基本的备份和还原功能
- **测试步骤**：
  1. 创建测试源目录和文件
  2. 执行备份操作
  3. 验证备份文件生成
  4. 删除源目录
  5. 执行还原操作
  6. 验证源目录和文件完整还原

#### 4.1.2 增量备份测试
- **测试目标**：验证增量备份功能
- **测试步骤**：
  1. 创建初始源目录和文件
  2. 执行完整备份
  3. 修改部分文件并添加新文件
  4. 执行增量备份
  5. 验证增量备份文件大小和内容
  6. 还原测试

#### 4.1.3 加密备份还原测试
- **测试目标**：验证加密备份和还原功能
- **测试步骤**：
  1. 创建测试源目录和文件
  2. 配置加密备份任务
  3. 执行加密备份
  4. 执行加密还原
  5. 验证还原文件完整性

#### 4.1.4 压缩备份还原测试
- **测试目标**：验证压缩备份和还原功能
- **测试步骤**：
  1. 创建测试源目录和大文件
  2. 配置压缩备份任务
  3. 执行压缩备份
  4. 验证压缩率
  5. 执行压缩还原
  6. 验证还原文件完整性

#### 4.1.5 实时备份测试
- **测试目标**：验证实时备份功能
- **测试步骤**：
  1. 配置实时备份监控
  2. 创建和修改源文件
  3. 验证备份目录中实时出现新文件/修改
  4. 测试文件删除场景

#### 4.1.6 定时备份测试
- **测试目标**：验证定时备份功能
- **测试步骤**：
  1. 配置定时备份任务（短时间间隔）
  2. 等待备份触发
  3. 验证备份文件生成
  4. 验证备份日志

## 5. 性能测试设计

### 5.1 核心性能指标
- 备份速度（MB/s）
- 还原速度（MB/s）
- 压缩率
- CPU使用率
- 内存使用率

### 5.2 性能测试场景

#### 5.2.1 大文件备份性能测试
- **测试目标**：测试单个大文件的备份性能
- **测试配置**：
  - 文件大小：1GB、5GB、10GB
  - 不同压缩级别
  - 加密开启/关闭

#### 5.2.2 大量小文件备份性能测试
- **测试目标**：测试大量小文件的备份性能
- **测试配置**：
  - 文件数量：10,000个
  - 平均文件大小：1KB
  - 不同目录深度

#### 5.2.3 实时备份性能测试
- **测试目标**：测试实时备份在高频率文件变更下的性能
- **测试配置**：
  - 同时修改100个文件
  - 每秒修改10次
  - 持续时间：5分钟

#### 5.2.4 多任务并发性能测试
- **测试目标**：测试同时执行多个备份/还原任务的性能
- **测试配置**：
  - 并发任务数：2、4、8个
  - 不同任务类型组合

## 6. 测试运行与报告机制

### 6.1 测试运行方式
- **本地运行**：`cmake --build build --target test` 或 `ctest -C Release`
- **CI/CD集成**：GitHub Actions或GitLab CI
- **构建脚本支持**：通过`build_linux.sh -t`运行测试

### 6.2 测试报告
- **覆盖率报告**：使用gcov/lcov生成覆盖率报告
- **测试结果输出**：CTest XML格式报告
- **日志记录**：详细的测试执行日志

### 6.3 测试环境
- **操作系统**：Windows 10/11, Ubuntu 20.04/22.04
- **编译器**：GCC 9+, Clang 10+, MSVC 2019+
- **硬件配置**：
  - CPU：至少4核
  - 内存：至少8GB
  - 磁盘：至少50GB可用空间

## 7. 测试文件结构

```
src/
├── core/
│   ├── models/
│   ├── tasks/
│   └── ...
├── utils/
├── FilterTests.cpp        # 现有测试文件
├── FileTests.cpp          # 新增
├── BackupTaskTests.cpp    # 新增
├── RestoreTaskTests.cpp   # 新增
├── BackupEngineTests.cpp  # 新增
├── EncryptionTests.cpp    # 新增
├── FilePackagerTests.cpp  # 新增
├── HuffmanCompressorTests.cpp  # 新增
└── IntegrationTests.cpp   # 新增
```

## 8. 测试执行计划

### 8.1 单元测试开发顺序
1. 完成现有Filter测试的完善
2. 开发File类测试
3. 开发工具类测试（Encryption, FilePackager等）
4. 开发Task类测试
5. 开发BackupEngine测试
6. 开发RealTimeBackupManager和TimerBackupManager测试

### 8.2 集成测试开发顺序
1. 模块间集成测试
2. 功能集成测试

### 8.3 端到端测试开发顺序
1. 基础备份还原测试
2. 加密压缩测试
3. 实时和定时备份测试
4. 增量备份测试

### 8.4 性能测试开发顺序
1. 大文件备份性能测试
2. 大量小文件备份性能测试
3. 实时备份性能测试
4. 多任务并发性能测试

## 9. 测试维护策略

- **测试用例更新**：每次核心功能变更时更新相应测试用例
- **测试覆盖率监控**：定期检查测试覆盖率，补充缺失的测试用例
- **测试环境维护**：确保测试环境与生产环境的一致性
- **测试数据管理**：使用自动化脚本生成和清理测试数据

## 10. 风险与应对措施

| 风险 | 应对措施 |
|------|----------|
| 测试环境与生产环境差异 | 建立标准化测试环境，定期同步配置 |
| 测试数据生成复杂 | 开发自动化测试数据生成工具 |
| 实时备份测试难以模拟 | 使用文件系统事件模拟工具 |
| 性能测试资源消耗大 | 限制性能测试运行频率，使用专门的测试服务器 |
| 测试用例维护成本高 | 采用测试驱动开发，保持测试用例与代码同步 |
